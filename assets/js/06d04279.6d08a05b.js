"use strict";(self.webpackChunkarchetype_docs=self.webpackChunkarchetype_docs||[]).push([[906],{8151:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>m,contentTitle:()=>l,default:()=>u,frontMatter:()=>p,metadata:()=>c,toc:()=>d});var a=n(7462),i=(n(7294),n(3905)),o=n(4996),s=n(6886),r=n(941);const p={sidebar_position:1,sidebar_label:"Framework"},l="Framework",c={unversionedId:"tests/framework",id:"tests/framework",title:"Framework",description:"This presents the technical framework for testing a smart contract (written in Archetype or Michelson): tests are written in Typescript and executed with Node.js.",source:"@site/docs/tests/framework.md",sourceDirName:"tests",slug:"/tests/framework",permalink:"/docs/tests/framework",draft:!1,editUrl:"https://github.com/completium/archetype-docs/blob/main/docs/tests/framework.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,sidebar_label:"Framework"},sidebar:"tests",previous:{title:"Introduction",permalink:"/docs/tests/introduction"},next:{title:"Writing Tests",permalink:"/docs/tests/writingtests"}},m={},d=[{value:"Runtime and language",id:"runtime-and-language",level:2},{value:"Contract Binding",id:"contract-binding",level:2},{value:"Michelson execution",id:"michelson-execution",level:2},{value:"Test library",id:"test-library",level:2},{value:"Completium packages",id:"completium-packages",level:2}],h={toc:d};function u(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"framework"},"Framework"),(0,i.kt)("p",null,"This presents the technical framework for testing a smart contract (written in Archetype or Michelson): tests are written in ",(0,i.kt)("a",{parentName:"p",href:"https://www.typescriptlang.org/"},"Typescript")," and executed with ",(0,i.kt)("a",{parentName:"p",href:"https://nodejs.org/en/"},"Node.js"),"."),(0,i.kt)("h2",{id:"runtime-and-language"},"Runtime and language"),(0,i.kt)("p",null,"The benefits of ",(0,i.kt)("a",{parentName:"p",href:"https://nodejs.org/en/"},"Node.js")," and the ",(0,i.kt)("a",{parentName:"p",href:"https://www.npmjs.com/"},"npm")," (yarn) packaging system is the access to a huge ecosystem of tools and utilities to implement tests."),(0,i.kt)("p",null,"The choice of ",(0,i.kt)("a",{parentName:"p",href:"https://www.typescriptlang.org/"},"Typescript")," (TS) language is motivated by its ",(0,i.kt)("em",{parentName:"p"},"strongly-typed")," aspect. A typed language helps validating the code at compilation time and reduce the effort and time to production."),(0,i.kt)("p",null,"Moreover it is fully-equipped in IDEs (like ",(0,i.kt)("a",{parentName:"p",href:"https://code.visualstudio.com/"},"VSCode"),", ",(0,i.kt)("a",{parentName:"p",href:"https://www.jetbrains.com/help/idea/typescript-support.html"},"IntelliJ"),", ...) with inlined code information (function docs and signatures, code navigation and refactoring, ...) and ",(0,i.kt)("a",{parentName:"p",href:"https://www.testim.io/blog/what-is-a-linter-heres-a-definition-and-quick-start-guide/"},"linters")," to detect issues at the time of coding, rather than at test execution, or even worse, after the contract is deployed."),(0,i.kt)("h2",{id:"contract-binding"},"Contract Binding"),(0,i.kt)("p",null,"The key feature of this test framework is the automatic contract's binding generation. The binding represents the contract in the Typescript world and provides the same API as the contract (storage, entry points, views). Hence invoking the contract is done via the contract's binding."),(0,i.kt)("p",null,"For example, consider the following Archetype contract:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-archetype",metastring:'title="bind_demo.arl"',title:'"bind_demo.arl"'},"archetype bind_demo\n\nvariable total : nat = 0\n\nentry increase(values : list<bool * nat>) {\n  for p in values do\n    total += p[0] ? p[1] : 0\n  done\n}\n")),(0,i.kt)("p",null,"The generated binding object provides, among other utilities, the following Typescript methods:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"deploy(params: Partial<ex.Parameters>): Promise<void>")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"increase(values: Array<[ boolean, Nat]>, params: Partial<Parameters>): Promise<any>")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"get_total(): Promise<Nat>"))),(0,i.kt)("p",null,"These methods may be called by the test:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="test.ts"',title:'"test.ts"'},"import { bind_demo }   from './binding/bind_hello'\nimport { Nat }         from \"@completium/archetype-ts-types\";\nimport { get_account } from \"@completium/experiment-ts\";\nconst assert = require('assert')\n\nconst alice = get_account('alice');\n/* Deploy contract */\nawait bind_demo.deploy({ as: alice })\n/* Invoke 'increase' entry point */\nawait bind_demo.increase([[ true, new Nat(2) ], [ false, new Nat(3) ]])\n/* Retrieve storage's total value */\nconst total = await bind_demo.get_total()\n/* Assert retrieved value */\nassert(total.equals(new Nat(2)))\n")),(0,i.kt)("p",null,"The main benefit of the binding interface is that the contract interface is known at ",(0,i.kt)("em",{parentName:"p"},"coding")," time."),(0,i.kt)("p",null,"For example, if the wrong type of argument is passed to the ",(0,i.kt)("inlineCode",{parentName:"p"},"increase")," method, an error is thrown instantly in the IDE (like VSCode below):"),(0,i.kt)(s.ZP,{container:!0,mdxType:"Grid"},(0,i.kt)(s.ZP,{item:!0,md:10,xs:12,mdxType:"Grid"},(0,i.kt)(r.Z,{alt:"Buld DApp",width:"100%",sources:{light:(0,o.Z)("img/binding/bind1_light.png"),dark:(0,o.Z)("img/binding/bind1.png")},mdxType:"ThemedImage"}))),(0,i.kt)("p",null,"It is then possible to display the expected type of argument by hovering the method:"),(0,i.kt)(s.ZP,{container:!0,mdxType:"Grid"},(0,i.kt)(s.ZP,{item:!0,md:11,xs:12,mdxType:"Grid"},(0,i.kt)(r.Z,{alt:"Buld DApp",width:"100%",sources:{light:(0,o.Z)("img/binding/bind2_light.png"),dark:(0,o.Z)("img/binding/bind2.png")},mdxType:"ThemedImage"}))),(0,i.kt)("p",null,"See the ",(0,i.kt)("a",{parentName:"p",href:"/docs/tests/binding"},"binding")," document for a detailed presentation of the generated API."),(0,i.kt)("h2",{id:"michelson-execution"},"Michelson execution"),(0,i.kt)("p",null,"In a test environement, the contract is executed locally with the ",(0,i.kt)("em",{parentName:"p"},"mockup")," mode of the ",(0,i.kt)("a",{parentName:"p",href:"https://research-development.nomadic-labs.com/announcing-octez.html"},"Octez")," distribution's client (named ",(0,i.kt)("inlineCode",{parentName:"p"},"tezos-client"),", see install ",(0,i.kt)("a",{parentName:"p",href:"https://assets.tqtezos.com/docs/setup/1-tezos-client/"},"instructions"),"). It is hence ",(0,i.kt)("em",{parentName:"p"},"necessary")," to install it and ",(0,i.kt)("a",{parentName:"p",href:"/docs/cli/network#mockup-init"},"inform")," Completium CLI about its path."),(0,i.kt)("p",null,"The benefit of the mockup mode is that it is uses the same execution engine as the tezos node. This removes the risk of a difference of exectuion semantics between test and production."),(0,i.kt)("h2",{id:"test-library"},"Test library"),(0,i.kt)("p",null,"It is best practise, and recommended, to use a generic purpose test library like ",(0,i.kt)("a",{parentName:"p",href:"https://mochajs.org/"},"Mocha")," or ",(0,i.kt)("a",{parentName:"p",href:"https://jestjs.io/"},"Jest"),"."),(0,i.kt)("p",null,"It helps structuring test scenarios in units and sequence of units; it provides a clear output of which tests are passing and which are not, with corresponding errors."),(0,i.kt)("p",null,"It can be combined with a code covering package to check whether all binding services are covered by tests."),(0,i.kt)("p",null,"See the Mocha section for more information."),(0,i.kt)("h2",{id:"completium-packages"},"Completium packages"),(0,i.kt)("p",null,"The framework relies on several packages:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/@completium/archetype-ts-types"},(0,i.kt)("inlineCode",{parentName:"a"},"@completium/archetype-ts-types"))," provides all bindings types (see types section)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/@completium/experiment-ts"},(0,i.kt)("inlineCode",{parentName:"a"},"@completium/experiment-ts"))," provides generic calls (to invoke the mockup mode) used by the binding, plus completium account utils (see API section)")),(0,i.kt)("p",null,"There is no need to install these packages manually when the ",(0,i.kt)("inlineCode",{parentName:"p"},"create project")," command is used. See here for more info."),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},"Note that it is also possible to use the binding generation in a ",(0,i.kt)("em",{parentName:"p"},"DApp"),". See ",(0,i.kt)("a",{parentName:"p",href:"http://localhost:3000/docs/dapps/example/"},"here")," for a full DApp example.")))}u.isMDXComponent=!0}}]);